"use strict";var fe=Object.create;var x=Object.defineProperty,ye=Object.defineProperties,we=Object.getOwnPropertyDescriptor,Se=Object.getOwnPropertyDescriptors,be=Object.getOwnPropertyNames,J=Object.getOwnPropertySymbols,Ee=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty,Te=Object.prototype.propertyIsEnumerable;var V=i=>{throw TypeError(i)};var Q=(i,e,t)=>e in i?x(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,E=(i,e)=>{for(var t in e||(e={}))Y.call(e,t)&&Q(i,t,e[t]);if(J)for(var t of J(e))Te.call(e,t)&&Q(i,t,e[t]);return i},B=(i,e)=>ye(i,Se(e));var Ae=(i,e)=>{for(var t in e)x(i,t,{get:e[t],enumerable:!0})},X=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of be(e))!Y.call(i,o)&&o!==t&&x(i,o,{get:()=>e[o],enumerable:!(r=we(e,o))||r.enumerable});return i};var L=(i,e,t)=>(t=i!=null?fe(Ee(i)):{},X(e||!i||!i.__esModule?x(t,"default",{value:i,enumerable:!0}):t,i)),Ce=i=>X(x({},"__esModule",{value:!0}),i);var Z=(i,e,t)=>e.has(i)||V("Cannot "+t);var s=(i,e,t)=>(Z(i,e,"read from private field"),t?t.call(i):e.get(i)),u=(i,e,t)=>e.has(i)?V("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),d=(i,e,t,r)=>(Z(i,e,"write to private field"),r?r.call(i,t):e.set(i,t),t);var a=(i,e,t)=>new Promise((r,o)=>{var n=p=>{try{f(t.next(p))}catch(h){o(h)}},l=p=>{try{f(t.throw(p))}catch(h){o(h)}},f=p=>p.done?r(p.value):Promise.resolve(p.value).then(n,l);f((t=t.apply(i,e)).next())});var ve={};Ae(ve,{AITool:()=>D,EmailTool:()=>$,EntitiesClient:()=>M,EntityClient:()=>O,FileTool:()=>q,FunctionsClient:()=>k,LumiAuthClient:()=>v,LumiClient:()=>K,ToolsClient:()=>N,createClient:()=>Le});module.exports=Ce(ve);var pe=require("uuid");var ne=L(require("crypto-js/enc-base64")),oe=L(require("crypto-js/enc-hex")),ae=L(require("crypto-js/hmac-sha256")),ce=L(require("crypto-js/sha256")),me=L(require("object-hash")),_=require("ofetch");var g=class extends Error{constructor(t,r){super(r);this.name="LumiError";this.code=t}};function W(){var i,e;return(e=(i=document.querySelector('link[rel="icon"]'))==null?void 0:i.href)!=null?e:null}function ee(){var i;return(i=document.title)!=null?i:null}var y=typeof window=="undefined";function te(i){return new Promise(e=>setTimeout(e,i))}function ie(i){var e;return typeof process!="undefined"&&(e=process==null?void 0:process.env[i])!=null?e:null}var Re="6QrJZ7pFCmBZAeIJF7IArvkCz+EtzA0RVcpHkiQIsQyhs7QtCS9P+CueZdHfB2OtJcgX3BbqY9pfpWeAVTqCwQ==";function re(i){return encodeURIComponent(i).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)}function Ie(i){let e=Math.floor(Date.now()/1e3).toString(),t=Math.random().toString(36).substring(2,15),r=E(E({},i.query),i.params),o=Object.keys(r).sort().map(c=>`${re(c)}=${re(String(r[c]))}`).join("&"),n={"x-timestamp":e,"x-nonce":t},l=Object.keys(n).sort().map(c=>`${c}:${n[c]}`).join(`
`),f=i.body&&!(i.body instanceof FormData)?JSON.stringify(i.body):"",p=(0,ce.default)(f).toString(oe.default),h=[o,l,p].join(`
`),R=ne.default.stringify((0,ae.default)(h,Re)),T=new Headers(i.headers);Object.entries(n).forEach(([c,G])=>{T.set(c,G)}),T.set("X-Sign",R),i.headers=T}var se=new Map;function xe(i,e){var l;let t=E({},e);e.body instanceof FormData&&(t.body=Array.from(e.body.entries())),t.headers=void 0;let r=(0,me.default)([i,t]),o=Date.now(),n=((l=se.get(r))==null?void 0:l.filter(f=>o-f<1e3))||[];if(n.length>=4)throw new g(429,"Too many requests");n.push(o),se.set(r,n)}function le(i,e,t,r=!1){t.headers=new Headers(t.headers),i.auth.accessToken&&t.headers.set("Authorization",`Bearer ${i.auth.accessToken}`),r&&(t.headers.get("Accept")||t.headers.set("Accept","text/event-stream"),t.headers.get("Cache-Control")||t.headers.set("Cache-Control","no-cache"),t.headers.get("X-Accel-Buffering")||t.headers.set("X-Accel-Buffering","no")),xe(e,t),Ie(t)}function m(i,e,t={}){le(i,e,t);let r=i.auth.isAuthenticated;return(0,_.ofetch)(e,B(E({baseURL:i.config.apiBaseUrl},t),{onResponse:({response:o})=>{var n;!y&&r&&((n=o._data)==null?void 0:n.code)===2100&&i.auth.signOut()}}))}function ue(r,o){return a(this,arguments,function*(i,e,t={}){return le(i,e,t,!0),yield(0,_.ofetch)(e,B(E({baseURL:i.config.apiBaseUrl},t),{responseType:"stream"}))})}function H(i,e,t=localStorage){let r=t.getItem(i),o=e?JSON.stringify(e):null;o?t.setItem(i,o):t.removeItem(i),window.dispatchEvent(new StorageEvent("storage",{key:i,oldValue:r,newValue:o,storageArea:t}))}function z(i,e=localStorage){let t=e.getItem(i);try{return t?JSON.parse(t):null}catch(r){return null}}var S,j,P,v=class{constructor(e){u(this,S);u(this,j,`lumi-auth-${(0,pe.v4)()}`);u(this,P,null);d(this,S,e),Promise.resolve().then(()=>{!y&&this.isAuthenticated&&this.refreshUser()})}get accessToken(){if(y){let e=s(this,S).config.authorization;return e?e.replace("Bearer ",""):null}return z("lumi-access-token")}set accessToken(e){if(y){s(this,S).config.authorization=e?`Bearer ${e}`:void 0;return}H("lumi-access-token",e)}get user(){return y?s(this,P):z("lumi-user")}set user(e){if(y){d(this,P,e);return}H("lumi-user",e)}get isAuthenticated(){return!!this.accessToken}signIn(){if(y)throw new Error("auth.signIn() can only be called on the client side");let e=800,t=600,r=(window.screen.width-e)/2,o=(window.screen.height-t)/2,n=window.open(s(this,S).config.authOrigin,s(this,j),`width=${e},height=${t},left=${r},top=${o}`),l;return new Promise((f,p)=>{if(!n)return p(new Error("Open auth window failed"));let h=setInterval(()=>{n.closed&&p(new Error("Auth window closed"))},1e3),R=c=>{n.closed||(n.focus(),c.stopPropagation(),c.preventDefault())},T=({data:c,origin:G,source:ge})=>{if(!(G!==s(this,S).config.authOrigin||ge!==n))switch(c==null?void 0:c.type){case"lumi-ready":{n.postMessage({type:"lumi-init",data:{projectId:s(this,S).config.projectId,icon:W(),title:ee()}},s(this,S).config.authOrigin);break}case"lumi-sign-in":{if(c.data.projectId!==s(this,S).config.projectId)break;n.close(),window.focus(),this.accessToken=c.data.accessToken,this.user=c.data.user,f(c.data);break}}};window.addEventListener("message",T),document.addEventListener("click",R,!0),l=()=>{clearInterval(h),window.removeEventListener("message",T),document.removeEventListener("click",R,!0)}}).finally(()=>l==null?void 0:l())}signOut(){if(y)throw new Error("auth.signOut() can only be called on the client side");this.accessToken=null,this.user=null}refreshUser(){return a(this,null,function*(){let e=yield m(s(this,S),"/lm/user/info",{method:"POST"});if(e.code!==200)throw new Error(e.message);return this.user=e.data,e.data})}onAuthChange(e){if(y)throw new Error("auth.onAuthChange() can only be called on the client side");let t=r=>{(r.key==="lumi-access-token"||r.key==="lumi-user"||r.key===null)&&e({isAuthenticated:this.isAuthenticated,user:this.user})};return window.addEventListener("storage",t),()=>{window.removeEventListener("storage",t)}}};S=new WeakMap,j=new WeakMap,P=new WeakMap;var w,O=class{constructor(e,t){u(this,w);d(this,w,e),this.entityName=t}list(){return a(this,arguments,function*({filter:e,sort:t,limit:r,skip:o}={}){if(r){let n=yield m(s(this,w),this.uri("/find"),{method:"POST",body:{filter:e,sort:t,limit:r,skip:o}});if(n.code!==200)throw new Error(n.message);return n.data}else{let n=yield m(s(this,w),this.uri("/list"),{method:"POST",body:{filter:e,sort:t}});if(n.code!==200)throw new Error(n.message);return{total:n.data.length,list:n.data}}})}get(e){return a(this,null,function*(){let t=yield m(s(this,w),this.uri(`/${e}`),{method:"GET"});if(t.code!==200)throw new Error(t.message);return t.data})}create(e){return a(this,null,function*(){let t=yield m(s(this,w),this.uri(),{method:"POST",body:e});if(t.code!==200)throw new Error(t.message);return t.data})}createMany(e){return a(this,null,function*(){let t=yield m(s(this,w),this.uri("/batch"),{method:"POST",body:e});if(t.code!==200)throw new Error(t.message);return t.data})}update(e,t){return a(this,null,function*(){let r=yield m(s(this,w),this.uri(),{method:"PUT",body:{filter:{_id:e},update:t}});if(r.code!==200)throw new Error(r.message);return r.data})}delete(e){return a(this,null,function*(){let t=yield m(s(this,w),this.uri(`/${e}`),{method:"DELETE"});if(t.code!==200)throw new Error(t.message)})}deleteMany(e){return a(this,null,function*(){let t=yield m(s(this,w),this.uri("/batch-by-ids"),{method:"DELETE",params:{ids:e}});if(t.code!==200)throw new Error(t.message)})}uri(e=""){return`/lm/${s(this,w).config.projectId}/${this.entityName}/documents${e}`}};w=new WeakMap;var U,M=class{constructor(e){u(this,U);return d(this,U,e),new Proxy(this,{get(t,r){return r in t||(t[r]=new O(s(t,U),r)),t[r]}})}};U=new WeakMap;var de=require("ofetch");var A,k=class{constructor(e){u(this,A);d(this,A,e)}invoke(e,t={}){return s(this,A).auth.accessToken&&(t.headers=E({Authorization:`Bearer ${s(this,A).auth.accessToken}`},t.headers)),(0,de.ofetch)(`/v1/functions/${s(this,A).config.projectId}/${e}`,E({baseURL:s(this,A).config.apiBaseUrl},t))}};A=new WeakMap;var he=require("eventsource-parser/stream");var b,D=class{constructor(e){u(this,b);d(this,b,e)}generateText(r){return a(this,arguments,function*({model:e="gemini-2.5-flash",messages:t}){let o=this.checkLumiApiKey(),n=yield m(s(this,b),`/lm/${s(this,b).config.projectId}/ai/chat/completions`,{method:"POST",body:{lumiApiKey:o,modelName:e,chatMessages:t}});if(n.code!==200)throw new g(n.code,n.message);return n.data})}generateTextStream(r){return a(this,arguments,function*({model:e="gemini-2.5-flash",messages:t}){let o=this.checkLumiApiKey();return ue(s(this,b),`/lm/${s(this,b).config.projectId}/ai/chat/stream`,{method:"POST",body:{lumiApiKey:o,modelName:e,chatMessages:t}})})}generateImage(r){return a(this,arguments,function*({model:e="gemini-2.5-flash-image",messages:t}){let o=this.checkLumiApiKey(),{code:n,message:l,data:f}=yield m(s(this,b),`/lm/${s(this,b).config.projectId}/ai/image/task`,{method:"POST",body:{lumiApiKey:o,modelName:e,chatMessages:t}});if(n!==200)throw new g(n,l);let p=f,h=1e3;for(;p.generationStatus==="PROCESSING";){yield te(h),h<5e3&&(h+=500);let{code:R,message:T,data:c}=yield m(s(this,b),`/lm/${s(this,b).config.projectId}/ai/image/get`,{method:"POST",body:{lumiApiKey:o,messageId:p.messageId}});if(R!==200)throw new g(R,T);p=c}return p})}parseStream(e){return a(this,null,function*(){return e.pipeThrough(new TextDecoderStream).pipeThrough(new he.EventSourceParserStream).pipeThrough(new TransformStream({transform:(t,r)=>{try{let o=JSON.parse(t.data);r.enqueue({event:t.event,data:o})}catch(o){console.error(`Parse stream chunk failed: Invalid JSON.
${t.data}`)}}}))})}checkLumiApiKey(){if(!y)throw new g(400,"lumi.tools.ai is only available on the server-side");let e=ie("LUMI_API_KEY");if(!e)throw new g(400,"LUMI_API_KEY is required");return e}};b=new WeakMap;var I,$=class{constructor(e){u(this,I);d(this,I,e)}send(p){return a(this,arguments,function*({to:e,subject:t,fromName:r,html:o,text:n="",replyTo:l,scheduledAt:f}){if(!e||!t||!o&&!n)throw new Error("Failed to send email: Missing required parameters.");typeof e=="string"&&(e=[e]),typeof l=="string"&&(l=[l]);let h=yield m(s(this,I),`/lm/${s(this,I).config.projectId}/email/send`,{method:"POST",body:{to:e,subject:t,fromName:r,html:o,text:n,replyTo:l,scheduledAt:f}});if(h.code!==200)throw new g(h.code,h.message)})}};I=new WeakMap;var C,q=class{constructor(e){u(this,C);d(this,C,e)}upload(e){return a(this,null,function*(){let t=new FormData;e.forEach(o=>{t.append("files",o)});let r=yield m(s(this,C),`/lm/${s(this,C).config.projectId}/file/batch`,{method:"POST",body:t});if(r.code!==200)throw new g(r.code,r.message);return r.data})}delete(e){return a(this,null,function*(){let t=yield m(s(this,C),`/lm/${s(this,C).config.projectId}/file/batch`,{method:"DELETE",body:{fileUrls:e}});if(t.code!==200)throw new g(t.code,t.message)})}};C=new WeakMap;var F,N=class{constructor(e){u(this,F);d(this,F,e),this.email=new $(e),this.file=new q(e),this.ai=new D(e)}};F=new WeakMap;var K=class{constructor(e){this.config=e,this.auth=new v(this),this.entities=new M(this),this.tools=new N(this),this.functions=new k(this)}};function Le(i){return new K(i)}0&&(module.exports={AITool,EmailTool,EntitiesClient,EntityClient,FileTool,FunctionsClient,LumiAuthClient,LumiClient,ToolsClient,createClient});
//# sourceMappingURL=index.js.map